local assert = require("luassert")
local vt = require("uitls.vt")

describe("vt.wrap_text_to_fit_width", function()
  it("should correctly wrap Chinese text with specified width", function()
    local max_display_width = 134
    local text =
      "ä¸Šå£«é—»é“ï¼Œå‹¤è€Œè¡Œä¹‹ï¼›ä¸­å£«é—»é“ï¼Œè‹¥å­˜è‹¥äº¡ï¼›ä¸‹å£«é—»é“ï¼Œå¤§ç¬‘ä¹‹ï¼Œä¸ç¬‘ä¸è¶³ä»¥ä¸ºé“ã€‚ä¸Šå£«é—»é“ï¼Œå‹¤è€Œè¡Œä¹‹ï¼›ä¸­å£«é—»é“ï¼Œè‹¥å­˜è‹¥äº¡ï¼›ä¸‹å£«é—»é“ï¼Œå¤§ç¬‘ä¹‹ï¼Œä¸ç¬‘ä¸è¶³ä»¥ä¸ºé“ã€‚ä¸Šå£«é—»é“ï¼Œå‹¤è€Œè¡Œä¹‹ï¼›ä¸­å£«é—»é“ï¼Œè‹¥å­˜è‹¥äº¡ï¼›ä¸‹å£«é—»é“ï¼Œå¤§ç¬‘ä¹‹ï¼Œä¸ç¬‘ä¸è¶³ä»¥ä¸ºé“"
    local expected_output = {
      "ä¸Šå£«é—»é“ï¼Œå‹¤è€Œè¡Œä¹‹ï¼›ä¸­å£«é—»é“ï¼Œè‹¥å­˜è‹¥äº¡ï¼›ä¸‹å£«é—»é“ï¼Œå¤§ç¬‘ä¹‹ï¼Œä¸ç¬‘ä¸è¶³ä»¥ä¸ºé“ã€‚ä¸Šå£«é—»é“ï¼Œå‹¤è€Œè¡Œä¹‹ï¼›ä¸­å£«é—»é“ï¼Œè‹¥å­˜è‹¥äº¡ï¼›ä¸‹å£«é—»é“ï¼Œå¤§ç¬‘ä¹‹ï¼Œä¸",
      "ç¬‘ä¸è¶³ä»¥ä¸ºé“ã€‚ä¸Šå£«é—»é“ï¼Œå‹¤è€Œè¡Œä¹‹ï¼›ä¸­å£«é—»é“ï¼Œè‹¥å­˜è‹¥äº¡ï¼›ä¸‹å£«é—»é“ï¼Œå¤§ç¬‘ä¹‹ï¼Œä¸ç¬‘ä¸è¶³ä»¥ä¸ºé“",
    }

    local result = vt.wrap_text_to_fit_width(text, max_display_width)

    -- Test length matches
    assert.equals(#expected_output, #result)

    -- Test content of each line
    for i, line in ipairs(expected_output) do
      assert.equals(line, result[i])
    end
  end)

  it("should correctly wrap complex text with symbols and emojis", function()
    local max_display_width = 134
    local text =
      [[Helloä¸–ç•Œï¼ä»Šó „‚å¤©æ˜¯2023-Ï€/2â‰ˆ5.15çš„å¥‡å¦™æ—¥æœŸğŸŒï¼åœ¨Î±åæ ‡ç³»ä¸­ï¼Œç”¨æˆ·@å¼ ä¸‰_Devéœ€è¦å°†â‚¬50è½¬æ¢ä¸ºÂ¥æˆ–$ï¼ŒåŒæ—¶è®¡ç®—âˆ‘(nÂ²)ä»n=1åˆ°âˆã€‚Î©å…¬å¸å‘å¸ƒçš„ğŸ“±App 2.0æ”¯æŒâ‰¤5Gbpsä¼ è¾“ï¼Œä½†éœ€æ³¨æ„âš ï¸ï¼šæ¸©åº¦é˜ˆå€¼åº”ä¿æŒ25Â°CÂ±3%ï¼ä»£ç æ®µif (x != y) { cout << "é”™è¯¯âŒ"; } åŒ…å«ä¸­æ–‡æ³¨é‡Š//è¿™é‡Œè¦å¤„ç†ASCIIç 32~126ã€‚æ•°å­¦å…¬å¼âˆ®EÂ·da = Q/Îµâ‚€å±•ç¤ºâˆ‡Â·E=Ï/Îµâ‚€çš„å¾®åˆ†å½¢å¼ã€‚è´­ç‰©æ¸…å•ğŸ“‹ï¼šğŸÃ—6ï¼ˆ$4.99ï¼‰ã€ğŸ“˜Ã—3ï¼ˆÂ¥59.8/æœ¬ï¼‰ï¼Œæ€»ä»·â‰ˆ$4.99Ã—6 + 59.8Ã—3 = $29.94 + ï¿¥179.4ã€‚éŸ³ä¹æ’­æ”¾åˆ—è¡¨ğŸµï¼šã€Šæœ€ä¼Ÿå¤§çš„ä½œå“ã€‹- å‘¨æ°å€«ï¼ˆJay Chouï¼‰ feat. éƒæœ—ï¼Œç ç‡320kbps@48kHzã€‚åœ°å€ç¤ºä¾‹ï¼šåŒ—äº¬å¸‚æµ·æ·€åŒº#36å·é™¢Â©2023ï¼Œåœ°å›¾åæ ‡39Â°54'27"N 116Â°23'17"Eã€‚ç‰¹æ®Šç¬¦å·æµ‹è¯•ï¼šâ˜…â˜†â˜¯â˜¢â˜£â™¬â™”â™›âš¡ğŸ”¥ğŸ’»âœ…ğŸ”ğŸ›‘ğŸš«âš–ï¸ğŸ”„ğŸ“¶ğŸ“¡ğŸ”‘ğŸ”“ğŸ’¡â—â“â€¼ï¸â‰ï¸â¡ï¸â¬…ï¸â†™ï¸â†—ï¸ğŸ”€ğŸ”ğŸ”‚â©âªâ«â¬ğŸ¦ğŸ”…ğŸ”†ğŸ•’ğŸ•˜ğŸ•§ğŸ”¢ğŸ”£ğŸ”¤ğŸ…°ï¸ğŸ†ğŸ†‘ğŸ†˜ğŸ†š]]

    local expected_output = {
      [[Helloä¸–ç•Œï¼ä»Šó „‚å¤©æ˜¯2023-Ï€/2â‰ˆ5.15çš„å¥‡å¦™æ—¥æœŸğŸŒï¼åœ¨Î±åæ ‡ç³»ä¸­ï¼Œç”¨æˆ·@å¼ ä¸‰_Devéœ€è¦å°†â‚¬50è½¬æ¢ä¸ºÂ¥æˆ–$ï¼ŒåŒæ—¶è®¡ç®—âˆ‘(nÂ²)ä»n=1åˆ°âˆã€‚Î©å…¬å¸å‘å¸ƒçš„ğŸ“±App ]],
      [[2.0æ”¯æŒâ‰¤5Gbpsä¼ è¾“ï¼Œä½†éœ€æ³¨æ„âš ï¸ï¼šæ¸©åº¦é˜ˆå€¼åº”ä¿æŒ25Â°CÂ±3%ï¼ä»£ç æ®µif (x != y) { cout << "é”™è¯¯âŒ"; } åŒ…å«ä¸­æ–‡æ³¨é‡Š//è¿™é‡Œè¦å¤„ç†ASCIIç 32~126ã€‚]],
      [[æ•°å­¦å…¬å¼âˆ®EÂ·da = Q/Îµâ‚€å±•ç¤ºâˆ‡Â·E=Ï/Îµâ‚€çš„å¾®åˆ†å½¢å¼ã€‚è´­ç‰©æ¸…å•ğŸ“‹ï¼šğŸÃ—6ï¼ˆ$4.99ï¼‰ã€ğŸ“˜Ã—3ï¼ˆÂ¥59.8/æœ¬ï¼‰ï¼Œæ€»ä»·â‰ˆ$4.99Ã—6 + 59.8Ã—3 = $29.94 + ]],
      [[ï¿¥179.4ã€‚éŸ³ä¹æ’­æ”¾åˆ—è¡¨ğŸµï¼šã€Šæœ€ä¼Ÿå¤§çš„ä½œå“ã€‹- å‘¨æ°å€«ï¼ˆJay Chouï¼‰ feat. éƒæœ—ï¼Œç ç‡320kbps@48kHzã€‚åœ°å€ç¤ºä¾‹ï¼šåŒ—äº¬å¸‚æµ·æ·€åŒº#36å·é™¢Â©2023ï¼Œåœ°å›¾]],
      [[åæ ‡39Â°54'27"N 116Â°23'17"Eã€‚ç‰¹æ®Šç¬¦å·æµ‹è¯•ï¼šâ˜…â˜†â˜¯â˜¢â˜£â™¬â™”â™›âš¡ğŸ”¥ğŸ’»âœ…ğŸ”ğŸ›‘ğŸš«âš–ï¸ğŸ”„ğŸ“¶ğŸ“¡ğŸ”‘ğŸ”“ğŸ’¡â—â“â€¼ï¸â‰ï¸â¡ï¸â¬…ï¸â†™ï¸â†—ï¸ğŸ”€ğŸ”ğŸ”‚â©âªâ«â¬ğŸ¦ğŸ”…ğŸ”†ğŸ•’ğŸ•˜ğŸ•§ğŸ”¢ğŸ”£ğŸ”¤ğŸ…°ï¸ğŸ†ğŸ†‘ğŸ†˜]],
      [[ğŸ†š]],
    }

    local result = vt.wrap_text_to_fit_width(text, max_display_width)

    -- Test length matches
    assert.equals(#expected_output, #result)

    -- Test content of each line
    for i, line in ipairs(expected_output) do
      assert.equals(line, result[i])
    end
  end)
end)
